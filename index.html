<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Push to this iPhone</title>

    <!-- PWA bits (required on iOS for Home Screen install + push) -->
    <link rel="manifest" href="manifest.webmanifest" />
  </head>
  <body style="font-family: system-ui; padding: 16px; max-width: 520px;">
    <h2>Push to this iPhone</h2>

    <p>
      <button id="btnSubscribe">Enable notifications</button>
      <span id="status" style="margin-left:8px;"></span>
    </p>

    <input id="msg" type="text" placeholder="Type notification text..."
           style="width:100%; padding:10px; font-size:16px;" />

    <p>
      <button id="btnSend">Send notification</button>
    </p>

    <script>
      // 1) Put your Cloudflare Worker URL here (Step 3).
      const API_BASE = "https://YOUR-WORKER.YOUR-SUBDOMAIN.workers.dev";

      // 2) Put your VAPID PUBLIC key here (Step 2).
      const VAPID_PUBLIC_KEY = "BBXwQxs50IT89DLPGs-QbSUYnRsJFNcShDstN4GIWwqLeGbHwT-3O3C1xRh2hH7TgablUAo69pESfB2Rk4ObZfQ";

      const statusEl = document.getElementById("status");
      const btnSubscribe = document.getElementById("btnSubscribe");
      const btnSend = document.getElementById("btnSend");

      function setStatus(s) { statusEl.textContent = s; }

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }

      async function ensureServiceWorker() {
        if (!("serviceWorker" in navigator)) throw new Error("No serviceWorker support");
        const reg = await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        return reg;
      }

      async function subscribe() {
        setStatus("Registering…");
        const reg = await ensureServiceWorker();

        setStatus("Requesting permission…");
        const perm = await Notification.requestPermission();
        if (perm !== "granted") throw new Error("Notification permission not granted");

        setStatus("Subscribing…");
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
        });

        setStatus("Saving subscription…");
        const r = await fetch(API_BASE + "/subscribe", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ subscription: sub }),
        });
        if (!r.ok) throw new Error("Backend /subscribe failed");
        const data = await r.json();

        // Save a device id + secret so only *you* can send to your device.
        localStorage.setItem("deviceId", data.deviceId);
        localStorage.setItem("deviceSecret", data.deviceSecret);

        setStatus("✅ Ready");
      }

      async function sendMessage() {
        const deviceId = localStorage.getItem("deviceId");
        const deviceSecret = localStorage.getItem("deviceSecret");
        if (!deviceId || !deviceSecret) {
          alert("First tap “Enable notifications”.");
          return;
        }

        const message = document.getElementById("msg").value.trim();
        if (!message) return;

        setStatus("Sending…");
        const r = await fetch(API_BASE + "/send", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ deviceId, deviceSecret, message }),
        });
        if (!r.ok) throw new Error("Backend /send failed");
        setStatus("✅ Sent");
      }

      btnSubscribe.addEventListener("click", () => subscribe().catch(e => {
        console.error(e);
        setStatus("❌ " + e.message);
      }));

      btnSend.addEventListener("click", () => sendMessage().catch(e => {
        console.error(e);
        setStatus("❌ " + e.message);
      }));

      setStatus(localStorage.getItem("deviceId") ? "Ready (already subscribed)" : "Not subscribed");
    </script>
  </body>
</html>
