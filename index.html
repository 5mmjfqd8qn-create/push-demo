<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fruit Predictor + Push</title>

  <!-- PWA bits (required on iOS for Home Screen install + push) -->
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; min-height: 100vh; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 24px; }
    .card {
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      user-select: none;
    }
    h1 { font-size: 22px; margin: 0 0 12px; }
    p { margin: 8px 0; line-height: 1.4; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; margin-bottom: 14px;
    }
    .topbar .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .status { font-size: 13px; color:#444; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin: 16px 0 14px;
    }
    .item {
      background: #f2f4ff;
      border: 1px solid #e1e6ff;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      font-weight: 600;
    }
    .btnRow { display:flex; justify-content:center; margin-top: 14px; gap:10px; flex-wrap:wrap; }
    button {
      border: 0; border-radius: 12px; padding: 12px 16px;
      font-size: 16px; font-weight: 700; cursor: pointer;
      background:#111; color:#fff;
    }
    button.secondary { background:#2f2f2f; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .result {
      font-size: 28px;
      font-weight: 900;
      text-align: center;
      padding: 16px;
      background: #fff7d6;
      border: 1px solid #ffe08a;
      border-radius: 14px;
      margin-top: 14px;
    }

    /* Make swipe feel good on mobile; we handle horizontal gestures ourselves */
    html, body { touch-action: pan-y; } /* keep vertical scroll, capture horizontal */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <!-- <button id="btnSubscribe" class="secondary">Enable notifications</button> -->
        <span id="status" class="status"></span>
      </div>
    </div>

    <div class="card" id="app"></div>
  </div>

  <script>
    // =========================
    // PUSH NOTIFICATION LOGIC
    // =========================
    // 1) Cloudflare Worker URL
    const API_BASE = "https://push-worker.watch-push-worker.workers.dev";

    // 2) VAPID PUBLIC key
    const VAPID_PUBLIC_KEY = "BBXwQxs50IT89DLPGs-QbSUYnRsJFNcShDstN4GIWwqLeGbHwT-3O3C1xRh2hH7TgablUAo69pESfB2Rk4ObZfQ";

    const statusEl = document.getElementById("status");
    const btnSubscribe = document.getElementById("btnSubscribe");

    function setStatus(s) { if (showStatus) statusEl.textContent = s; }

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    async function ensureServiceWorker() {
      if (!("serviceWorker" in navigator)) throw new Error("No serviceWorker support");
      const reg = await navigator.serviceWorker.register("./sw.js", { scope: "./" });
      return reg;
    }

    async function subscribe() {
      setStatus("Registering…");
      const reg = await ensureServiceWorker();

      setStatus("Requesting permission…");
      const perm = await Notification.requestPermission();
      if (perm !== "granted") throw new Error("Notification permission not granted");

      setStatus("Subscribing…");
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
      });

      setStatus("Saving subscription…");
      const r = await fetch(API_BASE + "/subscribe", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ subscription: sub }),
      });
      if (!r.ok) throw new Error("Backend /subscribe failed");
      const data = await r.json();

      localStorage.setItem("deviceId", data.deviceId);
      localStorage.setItem("deviceSecret", data.deviceSecret);

      setStatus("✅ Ready");
    }

    async function sendPush(message) {
      const deviceId = localStorage.getItem("deviceId");
      const deviceSecret = localStorage.getItem("deviceSecret");

      if (!deviceId || !deviceSecret) {
        setStatus("Enable notifications to receive the prediction");
        return { ok: false, reason: "not_subscribed" };
      }

      if (!message || !String(message).trim()) return { ok: false, reason: "empty_message" };

      setStatus("Sending…");
      const r = await fetch(API_BASE + "/send", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ deviceId, deviceSecret, message: String(message).trim() }),
      });
      if (!r.ok) {
        const msg = "Backend /send failed";
        setStatus("❌ " + msg);
        return { ok: false, reason: "send_failed" };
      }
      setStatus("✅ Sent");
      return { ok: true };
    }

    btnSubscribe.addEventListener("click", () => subscribe().catch(e => {
      console.error(e);
      setStatus("❌ " + e.message);
    }));

    setStatus(localStorage.getItem("deviceId") ? "Ready (already subscribed)" : "Not subscribed");

    
    let showStatus = true;
// =========================
    // FRUIT GAME LOGIC
    // =========================
    const fruits = [
      "Apple", "Banana", "Cherry", "Date",
      "Grape", "Kiwi", "Lemon", "Mango",
      "Orange", "Peach", "Pear", "Plum"
    ];

    const TOTAL_PAGES = 4;
    const YES_THRESHOLD_SECONDS = 10; // >10s => YES, <=10s => NO
    const SWIPE_MIN_PX = 70;
    const SWIPE_MAX_ANGLE_RATIO = 0.7;

    const fruitCodes = new Map(fruits.map((f, i) => [f, i]));

    let pageIndex = -1;    // -1 = intro, 0..3 = questions, 4 = result
    let answerCode = 0;
    let pageStartMs = 0;

    let dragging = false;
    let startX = 0, startY = 0;
    let activePointerId = null;

    const app = document.getElementById("app");

    function subsetForBit(bitIndex) {
      return fruits.filter(f => ((fruitCodes.get(f) >> bitIndex) & 1) === 1);
    }

    function startPageTimer() {
      pageStartMs = Date.now();
    }

    function computeYesNoFromTime() {
      const elapsedSeconds = (Date.now() - pageStartMs) / 1000;
      const isYes = elapsedSeconds > YES_THRESHOLD_SECONDS;
      return { isYes, elapsedSeconds };
    }

    function renderIntro() {
      showStatus = true;
      pageIndex = -1;
      answerCode = 0;

      app.innerHTML = `
        <h1>Think of a Fruit</h1>
        <p>Pick <b>one</b> fruit from this list and keep it in your head.</p>

        <div class="grid" aria-label="Fruit options">
          ${fruits.map(f => `<div class="item">${f}</div>`).join("")}
        </div>

        <div class="btnRow">
          <button id="startBtn">Start</button>
        </div>
      `;

      document.getElementById("startBtn").onclick = () => {
        pageIndex = 0;
        answerCode = 0;
        renderQuestion();
      };
    }

    function renderQuestion() {
      showStatus = false; statusEl.textContent = "";
      const bitIndex = pageIndex;
      const subset = subsetForBit(bitIndex);

      app.innerHTML = `
        <h1>Question ${pageIndex + 1} of ${TOTAL_PAGES}</h1>
        <p>Is your fruit in this subset?</p>

        <div class="grid">
          ${subset.map(f => `<div class="item">${f}</div>`).join("")}
        </div>
      `;

      startPageTimer();
    }

    function handleAdvance() {
      if (pageIndex < 0 || pageIndex >= TOTAL_PAGES) return;

      const { isYes } = computeYesNoFromTime();
      if (isYes) answerCode |= (1 << pageIndex);

      pageIndex++;

      if (pageIndex < TOTAL_PAGES) renderQuestion();
      else renderResult();
    }

    function renderResult() {
      showStatus = false; statusEl.textContent = "";
      const predicted = fruits.find(f => fruitCodes.get(f) === answerCode) || "No match";
      const prediction = predicted; // <- requested "prediction" value to push

      app.innerHTML = `
        <h1>Prediction</h1>
        <p>I think you were thinking of:</p>
        // <div class="result">${prediction}</div>
        <div class="result">"Ask Stef"</div>

        <div class="btnRow">
          <button id="restartBtn">Play Again</button>
        </div>
      `;

      // Trigger push automatically on arriving at the prediction page.
      // (If not subscribed yet, status tells the user to enable notifications.)
      sendPush(prediction).catch(e => {
        console.error("Send failed:", e);
        setStatus("❌ " + String(e && e.message ? e.message : e));
      });

      document.getElementById("restartBtn").onclick = renderIntro;
    }

    function attachGlobalSwipeHandlers() {
      document.addEventListener("pointerdown", (e) => {
        if (pageIndex < 0 || pageIndex >= TOTAL_PAGES) return;

        dragging = true;
        startX = e.clientX;
        startY = e.clientY;
        activePointerId = e.pointerId;

        try { document.body.setPointerCapture(activePointerId); } catch (_) {}
      }, { passive: true });

      document.addEventListener("pointerup", (e) => {
        if (!dragging) return;
        if (activePointerId !== null && e.pointerId !== activePointerId) return;

        dragging = false;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        const absDx = Math.abs(dx);
        const absDy = Math.abs(dy);

        const isHorizontal = absDx >= SWIPE_MIN_PX && absDy <= absDx * SWIPE_MAX_ANGLE_RATIO;
        if (isHorizontal) handleAdvance();

        activePointerId = null;
      }, { passive: true });

      document.addEventListener("pointercancel", () => {
        dragging = false;
        activePointerId = null;
      }, { passive: true });

      window.addEventListener("keydown", (e) => {
        if (pageIndex < 0 || pageIndex >= TOTAL_PAGES) return;
        if (e.key === " " || e.key === "Enter") {
          e.preventDefault();
          handleAdvance();
        }
      });
    }

    // Init
    renderIntro();
    attachGlobalSwipeHandlers();
  </script>
</body>
</html>
